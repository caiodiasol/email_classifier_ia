<!DOCTYPE html>
<html lang="pt-br" class="h-full antialiased">
<head>
    <meta charset="UTF-8">
    <title>Classificador de E-mails - IA</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonte -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>

    <script>
        tailwind.config = { darkMode: "class" };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }

        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: auto;
        }

        @keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }
    </style>
</head>

<body class="h-full bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100">

<!-- ====================================================== -->
<!-- SIDEBAR FIXO (SEM COLAPSO) -->
<!-- ====================================================== -->
<aside class="fixed top-0 left-0 h-full w-72 bg-white dark:bg-gray-800
              border-r border-gray-300 dark:border-gray-700 shadow-lg p-6 flex flex-col">

    <h1 class="text-2xl font-bold mb-6">游닎 Classificador IA</h1>

    <!-- Bot칚o Tema -->
    <button id="themeToggle"
            class="w-full px-4 py-2 mb-6 rounded-lg bg-gray-200 dark:bg-gray-700">
        Alternar Tema
    </button>

    <!-- Hist칩rico -->
    <h2 class="text-lg font-semibold mb-3">Hist칩rico</h2>

    <!-- Busca -->
    <input id="historySearch"
           placeholder="Buscar..."
           class="w-full px-3 py-2 mb-4 rounded-lg bg-gray-200 dark:bg-gray-700">

    <!-- Lista -->
    <div id="historyList"
         class="flex-1 overflow-y-auto space-y-4 pr-1"></div>

    <!-- Exportar -->
    <button id="csvBtn"
            class="w-full mt-4 px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white">
        Exportar CSV
    </button>
</aside>

<!-- ====================================================== -->
<!-- 츼REA PRINCIPAL -->
<!-- ====================================================== -->
<main class="ml-72 min-h-screen p-10 flex justify-center items-start">

    <div id="mainCard"
         class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-10 w-full max-w-3xl
                border border-gray-300 dark:border-gray-700">

        <h1 class="text-3xl font-bold text-center mb-6">Classificador Inteligente de E-mails</h1>

        <p class="text-center text-gray-600 dark:text-gray-300 mb-8">
            Insira o texto do e-mail ou envie um arquivo <strong>.txt</strong> ou <strong>.pdf</strong>.
        </p>

        <!-- FORM -->
        <div class="space-y-6">

            <!-- Textarea -->
            <textarea id="emailText"
                      class="w-full h-40 p-4 rounded-xl border
                             bg-white dark:bg-gray-900
                             border-gray-300 dark:border-gray-700
                             text-gray-800 dark:text-gray-100
                             focus:ring focus:ring-blue-300 dark:focus:ring-blue-800 transition"
                      placeholder="Cole o texto do e-mail aqui..."></textarea>

            <!-- Upload -->
            <div class="flex flex-col items-center justify-center border-2 border-dashed rounded-xl p-6
                        bg-gray-50 dark:bg-gray-700 hover:border-blue-500 transition cursor-pointer"
                 onclick="document.getElementById('fileInput').click()">

                <input id="fileInput" type="file" accept=".pdf,.txt" class="hidden">

                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 dark:text-gray-300 mb-2"
                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6.1M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>

                <p class="text-gray-500 dark:text-gray-300">Clique para enviar um arquivo (.pdf ou .txt)</p>
            </div>

            <!-- Bot칚o -->
            <button id="processBtn"
                    class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow">
                Processar E-mail
            </button>
        </div>

        <!-- LOADING -->
        <div id="loading" class="hidden mt-6 text-center">
            <div class="spinner"></div>
            <p class="text-gray-500 mt-3">Processando com IA...</p>
        </div>

        <!-- ====================================================== -->
        <!-- RESULTADO COMPLETO -->
        <!-- ====================================================== -->
        <div id="result"
             class="hidden mt-8 p-6 rounded-xl border shadow-sm
                    bg-gray-50 dark:bg-gray-700">

            <h2 class="text-xl font-bold mb-3">Resultado</h2>

            <!-- Categoria + Marcador -->
            <div class="flex items-center mb-2">
                <strong class="mr-2">Categoria:</strong>
                <span id="categoryDot" class="w-3 h-3 rounded-full mr-2"></span>
                <span id="category"></span>
            </div>

            <!-- Resumo -->
            <div id="summaryBox" class="mt-3 mb-4 hidden">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-1"><strong>Resumo:</strong></p>
                <p id="summaryText"
                   class="text-sm p-3 rounded-lg bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600"></p>
            </div>

            <!-- Confian칞a -->
            <div id="confidenceBox" class="mt-4 hidden">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
                    <strong>Confian칞a da Classifica칞칚o:</strong>
                    <span id="confidenceValue"></span>
                </p>

                <div class="w-full h-3 bg-gray-300 dark:bg-gray-800 rounded-full overflow-hidden">
                    <div id="confidenceBar"
                         class="h-full rounded-full bg-blue-600 transition-all duration-500"></div>
                </div>
            </div>

            <!-- Resposta -->
            <p class="mt-6"><strong>Resposta Sugerida:</strong></p>
            <p id="suggested"
               class="mt-2 p-4 bg-white dark:bg-gray-900 border rounded-xl"></p>
        </div>

        <!-- ERROR -->
        <div id="errorBox"
             class="hidden mt-6 p-4 rounded-xl bg-red-100 dark:bg-red-900
                    text-red-700 dark:text-red-300 border border-red-300 dark:border-red-700">
        </div>
    </div>
</main>

<!-- ====================================================== -->
<!-- SCRIPT -->
<!-- ====================================================== -->
<script>
    const fm = window.framerMotion;
    const API_BASE_URL = (window.API_BASE_URL || "https://email-classifier-ia-8iqe.onrender.com").replace(/\/$/, "");

    /* ======================== Tema ======================== */
    const thBtn = document.getElementById("themeToggle");

    thBtn.onclick = () => {
        document.documentElement.classList.toggle("dark");
        localStorage.setItem("theme",
            document.documentElement.classList.contains("dark") ? "dark" : "light"
        );
    };

    if (localStorage.getItem("theme") === "dark") {
        document.documentElement.classList.add("dark");
    }

    /* ======================== Hist칩rico ======================== */
    let historyData = [];
    const historyList = document.getElementById("historyList");
    const historySearch = document.getElementById("historySearch");

    function renderHistory(filter = "") {
        historyList.innerHTML = "";
        const q = filter.toLowerCase();

        const filtered = historyData.filter(h =>
            h.fullText.toLowerCase().includes(q) ||
            h.shortText.toLowerCase().includes(q) ||
            h.category.toLowerCase().includes(q)
        );

        filtered.forEach(item => {
            const block = document.createElement("div");
            block.className =
                "p-4 rounded-lg bg-gray-100 dark:bg-gray-900 border border-gray-300 " +
                "dark:border-gray-700 shadow";

            block.innerHTML = `
                <p class="font-semibold text-blue-600 dark:text-blue-400">${item.category}</p>
                <p class="mt-2 text-sm">${item.shortText}...</p>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">${item.date}</p>
            `;
            historyList.appendChild(block);
        });
    }

    function addToHistory(fullText, category) {
        historyData.unshift({
            category,
            fullText,
            shortText: fullText.substring(0, 100),
            date: new Date().toLocaleString()
        });
        renderHistory(historySearch.value);
    }

    historySearch.oninput = () => renderHistory(historySearch.value);

    /* ======================== Exportar CSV ======================== */
    document.getElementById("csvBtn").onclick = () => {
        if (!historyData.length) return alert("Nenhum item no hist칩rico.");

        let csv = "Categoria,Resumo,Data,Texto Completo\n";

        historyData.forEach(h => {
            csv += `"${h.category}","${h.shortText.replace(/"/g,"'")}","${h.date}","${h.fullText.replace(/\n/g," ").replace(/"/g,"'")}"\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "historico.csv";
        a.click();
    };

    /* ======================== Processamento ======================== */
    const processBtn = document.getElementById("processBtn");
    const loading = document.getElementById("loading");

    processBtn.onclick = async () => {
        const text = document.getElementById("emailText").value.trim();
        const file = document.getElementById("fileInput").files[0];

        const fd = new FormData();
        fd.append("text", text);
        if (file) fd.append("file", file);

        loading.classList.remove("hidden");
        document.getElementById("result").classList.add("hidden");

        const res = await fetch(`${API_BASE_URL}/api/process`, { method: "POST", body: fd });
        const data = await res.json();

        loading.classList.add("hidden");

        if (data.error) {
            const box = document.getElementById("errorBox");
            box.innerText = data.error;
            box.classList.remove("hidden");
            return;
        }

        document.getElementById("errorBox").classList.add("hidden");

        // Categoria + Marcador
        document.getElementById("category").innerText = data.category;
        const dot = document.getElementById("categoryDot");

        if (data.category === "Produtivo") {
            dot.className = "w-3 h-3 rounded-full mr-2 bg-green-500";
        } else {
            dot.className = "w-3 h-3 rounded-full mr-2 bg-gray-400";
        }

        // Resumo
        if (data.summary) {
            document.getElementById("summaryText").innerText = data.summary;
            document.getElementById("summaryBox").classList.remove("hidden");
        } else {
            document.getElementById("summaryBox").classList.add("hidden");
        }

        // Confian칞a
        const confidenceBox = document.getElementById("confidenceBox");
        const confidenceBar = document.getElementById("confidenceBar");
        const confidenceValue = document.getElementById("confidenceValue");

        if (data.confidence !== undefined && data.confidence !== null) {
            let pct = Math.round(data.confidence * 100);
            confidenceValue.innerText = pct + "%";
            confidenceBar.style.width = pct + "%";

            if (pct >= 80) confidenceBar.className = "h-full rounded-full bg-green-600";
            else if (pct >= 60) confidenceBar.className = "h-full rounded-full bg-yellow-500";
            else confidenceBar.className = "h-full rounded-full bg-red-600";

            confidenceBox.classList.remove("hidden");
        } else {
            confidenceBox.classList.add("hidden");
        }

        // Sugest칚o
        document.getElementById("suggested").innerText = data.suggested_response;

        // Mostrar resultado
        const result = document.getElementById("result");
        result.classList.remove("hidden");

        // Hist칩rico
        addToHistory(text || "(arquivo)", data.category);

        // Anima칞칚o
        fm.animate("#result", { opacity: [0, 1], y: [20, 0] }, { duration: 0.4 });
    };
</script>

</body>
</html>
